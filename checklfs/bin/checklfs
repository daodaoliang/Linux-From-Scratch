#!/bin/bash

[ -x /usr/bin/clear ] && clear

list_packages()
{
	echo "You can check the following package installations:"
	echo
	ls $logbase
	exit
}

show_help()
{
	echo "Usage: $0 [-v] [-c5] [-l] [-h] {package}"
	echo "-v:      show verbose output"
	echo "-c5      use with LFS-Book Chapter 5 installation: check if"
	echo "         everything is statically linked"
	echo "-l:      list available package installation log files"
	echo "-h:      help - this screen"
	echo "package: the package whose installation you wish to check"
	echo
	exit
}

print_status()
{
	if [ $# = 0 ]; then
		echo "Usage: $0 {success|failure}"
		return 1
	fi

	$CURS_UP

	case "$1" in
		success)
			$SET_COL
			echo -n "[  "
			$SUCCESS
			echo -n "OK"
			$NORMAL
			echo "  ]"
			;;
		failure)
			$SET_COL
			echo -n "["
			$FAILURE
			echo -n "FAILED"
			$NORMAL
			echo "]"
			;;
	esac
}

COLUMNS=$(stty size)
COLUMNS=${COLUMNS##* }
COL=$[ $COLUMNS - 10 ]
SET_COL="echo -en \\033[${COL}G"
CURS_UP="echo -en \\033[A"
NORMAL="echo -en \\033[0;39m"
SUCCESS="echo -en \\033[1;32m"
FAILURE="echo -en \\033[1;31m"

verbose=""
c5=""
pkgname=""
root=""

errors_found=0

while [ -n "$1" ]; do
	case "$1" in
		-v) if [ -z "$verbose" ]; then verbose=1; fi
			shift
			;;

		-c5) if [ -z "$c5" ]; then c5="c5-"; fi

			if [ -n "$pkgname" ]; then pkgname=$c5$pkgname; fi
			shift
			;;

		-l)
			list_packages
			;;

		-h)
			show_help
			;;

		*)	pkgname=$c5$1 && shift
			;;
	esac
done

[ -n "$c5" ] && root="$LFS"
logbase=$root/usr/share/checklfs/install-logs
install_log=$logbase/$pkgname
results=$root/tmp/checklfs-$pkgname.results

[ -z "$pkgname" ] && show_help


{

echo "Checking the $pkgname installation..."
echo

if [ ! -f "$install_log" ]; then
	echo "Installation log file $pkgname could not be found."
	echo "Cannot proceed with test the installation of $pkgname."
	echo
	exit
elif [ ! -s "$install_log" ]; then
	echo "Installation log file $pkgname is 0 bytes in size. I don't"
	echo "have anything to check for."
	echo
	exit
fi

if [ -n "$verbose" ]; then
	echo "Using log file $install_log"
	echo
fi

for item in $(cat $install_log)
do
	item="$root$item"
	if [ -n "$verbose" ]; then
		echo "Checking for $item..."
	fi

	if [ ! -e "$item" ] && [ -z "$verbose" ]; then
		echo "$item doesn't exist."
		errors_found=1
	elif [ ! -e "$item" ] && [ -n "$verbose" ]; then
		print_status failure
		errors_found=1
	elif [ -n "$verbose" ]; then
		print_status success
	fi

	if [ -n "$c5" ]; then
		file $item | grep -q dynamically
		ret_value=$?
		if [ "$ret_value" = 0 ] && [ -n "$verbose" ]; then
			echo "Error: $item is dynamically linked."
			print_status failure
			errors_found=1
		elif [ "$ret_value" = 0 ] && [ -z "$verbose" ]; then
			echo "Error: $item is dynamically linked."
			errors_found=1
		fi
	fi
done

if [ "$errors_found" = 0 ]; then
	echo
	echo "No obvious problems found with the $pkgname installation."
	echo
else
	echo
	echo "Errors were encountered. You may want to reinstall the"
	echo "$pkgname package."
	echo
fi

echo
echo "For your convenience, all output from this test is stored in the"
echo "$results file."
echo

} 2>&1 | tee $results

exit $errors_found

