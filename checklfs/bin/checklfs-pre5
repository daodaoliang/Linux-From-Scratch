#!/bin/bash

clear

{

amd_inside=0
grep -q AMD /proc/cpuinfo
[ "$?" = 0 ] && amd_inside=1

curseslib=/usr/lib/libcurses.a
ncurseslib=/usr/lib/libncurses.a
glibc_minor=$(ls /lib/libc-2.*.so|cut -f 2 -d ".")
glibc_micro=$(ls /lib/libc-2.*.so|cut -f 3 -d ".")

if [ ! -f "$curseslib" ] && [ -f "$ncurseslib" ]; then
	echo "You are missing the $curseslib symlink to"
	echo "$ncurseslib Please run the following commands as root,"
	echo "then run this check again:"
	echo
	echo "cd /usr/lib &&"
	echo "ln -s libncurses.a libcurses.a"
	echo
	exit
elif [ ! -f "$curseslib" ] && [ ! -f "$ncurseslib" ]; then
	echo "You are missing both the $curseslib and $ncurseslib files"
	echo "Please install the ncurses-dev package (or something resembling "
	echo "that name) using your distribution's package installation tool."
	echo
	exit
fi

if [ "$glibc_minor" = 0 ]; then
	echo "The Glibc version detected on your system is 2.0.x. This means"
	echo "that the following package(s) need alternative installation"
	echo "instructions:"
	echo
	echo "gzip"
	echo
	echo "For gzip you need to apply the patch that you downloaded in"
	echo "chapter 3."
	echo
	echo "Instructions on how to fix these package(s) are provided in the book"
	echo "when you are going to install those packages. This is just an"
	echo "informative message."
	echo
	exit
fi

if [ "$glibc_minor" = 1 ]; then
	echo "The Glibc version detected on your system is 2.1.x. This means"
	echo "that the following package(s) need alternative installation"
	echo "instructions:"
	echo
	echo "diffutils, gawk, grep, sed and sh-utils"
	echo
	echo "for diffutils, gawk, grep and sed it's a simple matter of"
	echo "setting an environment variable to fix the problem. For sh-utils"
	echo "however, you need to apply the patch that you downloaded in"
	echo "chapter 3."
	echo
	echo "Instructions on how to fix these package(s) are provided in the book"
	echo "when you are going to install those packages. This is just an"
	echo "informative message."
	echo
	exit
fi

if [ "$amd_inside" = 1 ] && [ "$glibc_minor" = 2 ] && [ "$glibc_micro" = 3 ]
then
	echo "Your system has Glibc-2.2.3 and an AMD CPU. When you get to the"
	echo "fileutils installation, be sure to apply the fileutils fix."
	echo
	exit
fi
echo "No problems found during pre-chapter 5 check."

echo
echo "For your convenience, all output from this test is stored in the"
echo "$LFS/tmp/checklfs-pre5.results file."
echo

} 2>&1 | tee $LFS/tmp/checklfs-pre5.results
